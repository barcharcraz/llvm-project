# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  branches:
      include:
        - master
  paths:
    exclude:
      - azure-pipelines*.yml


jobs:
  - job: MSVC_Tests
    variables:
      - name: LLVM_VERSION
        value: 9.0.0
      - name: UNIX_BIN_DIR
        value: $(Build.ArtifactStagingDirectory)\unix\cygwin64\bin
      - name: ASAN_SYMBOLIZER_PATH
        value: $(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\\bin\llvm-symbolizer.exe
    


    timeoutInMinutes: 360
    pool:
      name: 'msvc-asan'
      demands:
        "Agent.Name -eq greenteam_002"

      
    steps:

    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'specific'
        project: '0bdbc590-a062-4c3f-b0f6-9383f67865ee'
        pipeline: '11796'
        buildVersionToDownload: 'latest'
        artifactName: llvm_asan_Release_x86_bin
        downloadType: 'specific'
        downloadPath: '$(System.ArtifactsDirectory)'
 
    - script: |
        taskkill /f /t /im mspdbsrv.exe
        taskkill /f /t /im msbuild.exe
        taskkill /f /t /im cl.exe 
        taskkill /f /t /im link.exe
        (exit /b 0)
      continueOnError: true
 
    - script: |
        pushd $(Build.SourcesDirectory)\llvm\utils\lit
        c:\python27\python.exe setup.py install
        popd
        (exit /b 0)

    - script: git clone https://$(sectools.token)@sectools.visualstudio.com/DefaultCollection/AddressSanitizer/_git/unix_test_dependencies $(Build.ArtifactStagingDirectory)\unix 2>&1
    
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: $(Build.ArtifactStagingDirectory)\unix\gnuwin32\unzip.ps1
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: Expand-Archive $(Build.ArtifactStagingDirectory)\unix\cygwin64.zip $(Build.ArtifactStagingDirectory)\unix\

    - script: |
        set PATH=$(Build.ArtifactStagingDirectory)\unix\gnuwin32\bin;$(Build.ArtifactStagingDirectory)\unix\bin;$(Build.ArtifactStagingDirectory)\unix\cygwin64\bin;%PATH%
        echo ##vso[task.prependpath]$(System.ArtifactsDirectory);$(Build.SourcesDirectory)\llvm\utils\lit;$(Build.SourcesDirectory)\llvm\utils\lit\lit;$(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\\bin;$(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\\lib\windows\x86;$(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\\include;$(System.ArtifactsDirectory)\\bin
        echo ##vso[task.prependpath]$(Build.ArtifactStagingDirectory)\unix\gnuwin32\bin;$(Build.ArtifactStagingDirectory)\unix\bin;$(Build.ArtifactStagingDirectory)\unix\cygwin64\bin
        where cat
        where awk
        where sed
        where grep
    
    - script: |
        echo on
        set ASAN_RT_SRC_ROOT=$(Build.SourcesDirectory)\compiler-rt
        call %MSVC_SRC%\binaries\x86chk\setenv.cmd x86 %MSVC_SRC%\src
        set INCLUDE=%INCLUDE%;$(Build.SourcesDirectory)\compiler-rt\include;
        pushd $(Build.SourcesDirectory)\llvm\utils\lit\lit
        c:\python27\python.exe $(Build.SourcesDirectory)\llvm\utils\lit\lit\msvc_main.py $(Build.SourcesDirectory)\compiler-rt\\test\\asan\TestCases\Windows x86 --write-sql-results -d pyodbc
        popd
      displayName: 'Run Windows specific tests default'
      env:
        TEST_OUTPUT_DIR: $(Build.BinariesDirectory)
        TEST_C_COMPILER: cl.exe
        ASAN_RT_LIB_DIR: $(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\lib\windows\x86
        ASAN_RT_BIN_DIR: $(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\\bin
        SQL_TABLE_NAME: windows_static
      continueOnError: 'true'


    - script: |
        echo on
        set ASAN_RT_SRC_ROOT=$(Build.SourcesDirectory)\compiler-rt
        call %MSVC_SRC%\binaries\x86chk\setenv.cmd x86 %MSVC_SRC%\src
        set INCLUDE=%INCLUDE%;$(Build.SourcesDirectory)\compiler-rt\include;
        pushd $(Build.SourcesDirectory)\llvm\utils\lit\lit
        c:\python27\python.exe $(Build.SourcesDirectory)\llvm\utils\lit\lit\msvc_main.py $(Build.SourcesDirectory)\compiler-rt\\test\\asan\TestCases\Windows x86 --force-dynamic --write-sql-results -d pyodbc
        popd

      displayName: 'Run Windows specific tests dynamic'
      env:
        TEST_OUTPUT_DIR: $(Build.BinariesDirectory)
        TEST_C_COMPILER: cl.exe
        ASAN_RT_LIB_DIR: $(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\lib\windows\x86
        ASAN_RT_BIN_DIR: $(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\\bin
        SQL_TABLE_NAME: windows_dynamic
      continueOnError: 'true'

    - script: |
        echo on
        set ASAN_RT_SRC_ROOT=$(Build.SourcesDirectory)\compiler-rt
        call %MSVC_SRC%\binaries\x86chk\setenv.cmd x86 %MSVC_SRC%\src
        set INCLUDE=%INCLUDE%;$(Build.SourcesDirectory)\compiler-rt\include;
        pushd $(Build.SourcesDirectory)\llvm\utils\lit\lit
        c:\python27\python.exe $(Build.SourcesDirectory)\llvm\utils\lit\lit\msvc_main.py $(Build.SourcesDirectory)\compiler-rt\\test\\asan\TestCases x86 --write-sql-results -d pyodbc
        popd
      displayName: 'Run asan tests static'
      env:
        TEST_OUTPUT_DIR: $(Build.BinariesDirectory)
        TEST_C_COMPILER: cl.exe
        ASAN_RT_LIB_DIR: $(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\lib\windows\x86
        ASAN_RT_BIN_DIR: $(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\\bin
        SQL_TABLE_NAME: asan_static
      continueOnError: 'true'

    - script: |
        echo on
        set ASAN_RT_SRC_ROOT=$(Build.SourcesDirectory)\compiler-rt
        call %MSVC_SRC%\binaries\x86chk\setenv.cmd x86 %MSVC_SRC%\src
        set INCLUDE=%INCLUDE%;$(Build.SourcesDirectory)\compiler-rt\include;
        pushd $(Build.SourcesDirectory)\llvm\utils\lit\lit
        c:\python27\python.exe $(Build.SourcesDirectory)\llvm\utils\lit\lit\msvc_main.py $(Build.SourcesDirectory)\compiler-rt\\test\\asan\TestCases x86 --write-sql-results -d pyodbc --force-dynamic
        popd
      displayName: 'Run asan tests dynamic'
      env:
        TEST_OUTPUT_DIR: $(Build.BinariesDirectory)
        TEST_C_COMPILER: cl.exe
        ASAN_RT_LIB_DIR: $(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\lib\windows\x86
        ASAN_RT_BIN_DIR: $(System.ArtifactsDirectory)\llvm_asan_Release_x86_bin\\bin
        SQL_TABLE_NAME: asan_dynamic
      continueOnError: 'true'

