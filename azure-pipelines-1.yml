# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  branches:
      include:
        - master
  paths:
    exclude:
      - azure-pipelines.yml
      - azure-pipelines-1.yml
      - azure-pipelines-2.yml
      - azure-pipelines-3.yml
      - llvm/utils/lit/lit/msvc_main.py
      - nonship-RegLogProcess.py



jobs:
  - job: MSVC_Tests

    timeoutInMinutes: 60
    pool:
      name: 'msvc-asan'

    strategy:
      matrix:
        Win_x86:
          LlvmArtifactID: llvm_asan_Release_x86_bin
          MsvcTargetArch: x86
          VcVars: vcvars32.bat
          MsvcHostArch: x86chk
          UNIX_BIN_DIR: $(System.ArtifactsDirectory)\unix\cygwin64\bin
          ASAN_SYMBOLIZER_PATH: $(System.ArtifactsDirectory)\$(LlvmArtifactID)\bin\llvm-symbolizer.exe
          ASAN_RT_SRC_ROOT: $(Build.SourcesDirectory)\compiler-rt
          TEST_OUTPUT_DIR: $(Build.BinariesDirectory)
          TEST_C_COMPILER: cl.exe
          ASAN_RT_LIB_DIR: $(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\x86
          ASAN_RT_BIN_DIR: $(System.ArtifactsDirectory)\$(LlvmArtifactID)\bin
        Win_x64_x86:
          LlvmArtifactID: llvm_asan_Release_x86_bin
          MsvcTargetArch: x86
          VcVars: vcvarsamd64_x86.bat
          MsvcHostArch: amd64chk
          UNIX_BIN_DIR: $(System.ArtifactsDirectory)\unix\cygwin64\bin
          ASAN_SYMBOLIZER_PATH: $(System.ArtifactsDirectory)\$(LlvmArtifactID)\bin\llvm-symbolizer.exe
          ASAN_RT_SRC_ROOT: $(Build.SourcesDirectory)\compiler-rt
          TEST_OUTPUT_DIR: $(Build.BinariesDirectory)
          TEST_C_COMPILER: cl.exe
          ASAN_RT_LIB_DIR: $(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\x86
          ASAN_RT_BIN_DIR: $(System.ArtifactsDirectory)\$(LlvmArtifactID)\bin


    steps:
     

    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'specific'
        project: '0bdbc590-a062-4c3f-b0f6-9383f67865ee'
        pipeline: '11796'
        buildVersionToDownload: 'latest'
        artifactName: $(LlvmArtifactID)
        downloadType: 'specific'
        downloadPath: '$(System.ArtifactsDirectory)'

    - script: |
        taskkill /f /t /im mspdbsrv.exe 2>&1
        taskkill /f /t /im msbuild.exe 2>&1
        taskkill /f /t /im cl.exe 2>&1
        taskkill /f /t /im link.exe 2>&1
        (exit /b 0)
      continueOnError: true

    - script: |
        pushd $(Build.SourcesDirectory)\llvm\utils\lit
        c:\python27\python.exe setup.py install
        popd
        (exit /b 0)

    - script: git clone https://$(sectools.token)@sectools.visualstudio.com/DefaultCollection/AddressSanitizer/_git/unix_test_dependencies $(Build.ArtifactStagingDirectory)\unix 2>&1

    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: $(Build.ArtifactStagingDirectory)\unix\gnuwin32\unzip.ps1
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: Expand-Archive $(Build.ArtifactStagingDirectory)\unix\cygwin64.zip $(Build.ArtifactStagingDirectory)\unix\


    - script: |
        echo on
        set PATH=%PATH%;$(System.ArtifactsDirectory)\unix\gnuwin32\bin;$(System.ArtifactsDirectory)\unix\bin;$(System.ArtifactsDirectory)\unix\cygwin64\bin;$(System.ArtifactsDirectory);$(Build.SourcesDirectory)\llvm\utils\lit;$(Build.SourcesDirectory)\llvm\utils\lit\lit;$(System.ArtifactsDirectory)\$(LlvmArtifactID)\bin;$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\x86;$(System.ArtifactsDirectory)\$(LlvmArtifactID)\include;$(System.ArtifactsDirectory)\bin;
        call %MSVC_SRC%\binaries\$(MsvcHostArch)\setenv.cmd $(MsvcTargetArch) %MSVC_SRC%\src
        set PATH=$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\$(MsvcTargetArch);%PATH%;
        set LIB=$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\$(MsvcTargetArch);%LIB%;
        set INCLUDE=%INCLUDE%;$(Build.SourcesDirectory)\compiler-rt\include;$(Build.SourcesDirectory)\compiler-rt\test\asan\TestCases\defines.h
        pushd $(Build.SourcesDirectory)\llvm\utils\lit\lit
        c:\python27\python.exe $(Build.SourcesDirectory)\llvm\utils\lit\lit\msvc_main.py $(Build.SourcesDirectory)\compiler-rt\test\asan\TestCases\Windows $(MsvcTargetArch) --write-sql-results -d pyodbc
        popd
      displayName: 'Run Windows specific tests default'
      env:
        SQL_TABLE_NAME: windows_static
      continueOnError: 'true'


    - script: |
        echo on
        set PATH=%PATH%;$(System.ArtifactsDirectory)\unix\gnuwin32\bin;$(System.ArtifactsDirectory)\unix\bin;$(System.ArtifactsDirectory)\unix\cygwin64\bin;$(System.ArtifactsDirectory);$(Build.SourcesDirectory)\llvm\utils\lit;$(Build.SourcesDirectory)\llvm\utils\lit\lit;$(System.ArtifactsDirectory)\$(LlvmArtifactID)\bin;$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\$(MsvcTargetArch);$(System.ArtifactsDirectory)\$(LlvmArtifactID)\include;$(System.ArtifactsDirectory)\bin;
        call %MSVC_SRC%\binaries\$(MsvcHostArch)\setenv.cmd $(MsvcTargetArch) %MSVC_SRC%\src
        set PATH=$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\$(MsvcTargetArch);%PATH%;
        set LIB=$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\$(MsvcTargetArch);%LIB%;
        set INCLUDE=%INCLUDE%;$(Build.SourcesDirectory)\compiler-rt\include;$(Build.SourcesDirectory)\compiler-rt\test\asan\TestCases\defines.h
        pushd $(Build.SourcesDirectory)\llvm\utils\lit\lit
        c:\python27\python.exe $(Build.SourcesDirectory)\llvm\utils\lit\lit\msvc_main.py $(Build.SourcesDirectory)\compiler-rt\test\asan\TestCases\Windows $(MsvcTargetArch) --force-dynamic --write-sql-results -d pyodbc
        popd

      displayName: 'Run Windows specific tests dynamic'
      env:
        SQL_TABLE_NAME: windows_dynamic
      continueOnError: 'true'

    - script: |
        echo on
        set PATH=%PATH%;$(System.ArtifactsDirectory)\unix\gnuwin32\bin;$(System.ArtifactsDirectory)\unix\bin;$(System.ArtifactsDirectory)\unix\cygwin64\bin;$(System.ArtifactsDirectory);$(Build.SourcesDirectory)\llvm\utils\lit;$(Build.SourcesDirectory)\llvm\utils\lit\lit;$(System.ArtifactsDirectory)\$(LlvmArtifactID)\bin;$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\$(MsvcTargetArch);$(System.ArtifactsDirectory)\$(LlvmArtifactID)\include;$(System.ArtifactsDirectory)\bin;
        call %MSVC_SRC%\binaries\$(MsvcHostArch)\setenv.cmd $(MsvcTargetArch) %MSVC_SRC%\src
        set PATH=$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\$(MsvcTargetArch);%PATH%;
        set LIB=$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\$(MsvcTargetArch);%LIB%;
        set INCLUDE=%INCLUDE%;$(Build.SourcesDirectory)\compiler-rt\include;$(Build.SourcesDirectory)\compiler-rt\test\asan\TestCases\defines.h
        pushd $(Build.SourcesDirectory)\llvm\utils\lit\lit
        c:\python27\python.exe $(Build.SourcesDirectory)\llvm\utils\lit\lit\msvc_main.py $(Build.SourcesDirectory)\compiler-rt\test\asan\TestCases $(MsvcTargetArch) --write-sql-results -d pyodbc
        popd
      displayName: 'Run asan tests static'
      env:
        SQL_TABLE_NAME: asan_static
      continueOnError: 'true'

    - script: |
        echo on
        set PATH=%PATH%;$(System.ArtifactsDirectory)\unix\gnuwin32\bin;$(System.ArtifactsDirectory)\unix\bin;$(System.ArtifactsDirectory)\unix\cygwin64\bin;$(System.ArtifactsDirectory);$(Build.SourcesDirectory)\llvm\utils\lit;$(Build.SourcesDirectory)\llvm\utils\lit\lit;$(System.ArtifactsDirectory)\$(LlvmArtifactID)\bin;$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\$(MsvcTargetArch);$(System.ArtifactsDirectory)\$(LlvmArtifactID)\include;$(System.ArtifactsDirectory)\bin;
        call %MSVC_SRC%\binaries\$(MsvcHostArch)\setenv.cmd $(MsvcTargetArch) %MSVC_SRC%\src
        set PATH=$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\$(MsvcTargetArch);%PATH%;
        set LIB=$(System.ArtifactsDirectory)\$(LlvmArtifactID)\lib\windows\$(MsvcTargetArch);%LIB%;
        set INCLUDE=%INCLUDE%;$(Build.SourcesDirectory)\compiler-rt\include;$(Build.SourcesDirectory)\compiler-rt\test\asan\TestCases\defines.h
        pushd $(Build.SourcesDirectory)\llvm\utils\lit\lit
        c:\python27\python.exe $(Build.SourcesDirectory)\llvm\utils\lit\lit\msvc_main.py $(Build.SourcesDirectory)\compiler-rt\test\asan\TestCases $(MsvcTargetArch) --write-sql-results -d pyodbc --force-dynamic
        popd
      displayName: 'Run asan tests dynamic'
      env:
        SQL_TABLE_NAME: asan_dynamic
      continueOnError: 'true'
